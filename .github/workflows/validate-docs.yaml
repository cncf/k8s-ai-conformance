name: Validate Documentation

on:
  pull_request:
    paths:
      - 'docs/AIConformance-*.yaml'
      - 'docs/AIConformance-*.md'
      - 'v*/*/PRODUCT.yaml'
      - 'v*/*/PRODUCT.md'
      - 'scripts/yaml-to-markdown.go'
  push:
    branches:
      - main
    paths:
      - 'docs/AIConformance-*.yaml'
      - 'v*/*/PRODUCT.yaml'
      - 'scripts/yaml-to-markdown.go'
  workflow_dispatch:

jobs:
  validate-markdown:
    name: Validate Markdown is in sync with YAML
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Install dependencies
        run: go mod download

      - name: Regenerate Markdown files
        run: go run scripts/yaml-to-markdown.go

      - name: Check for differences
        run: |
          # Check both docs/ and version directories
          changed_files=$(git diff --name-only '*.md' || true)

          if [ -z "$changed_files" ]; then
            echo "✅ All Markdown files are up to date"
          else
            echo "❌ Markdown files are out of sync with YAML sources"
            echo ""
            echo "The following files have differences:"
            echo "$changed_files"
            echo ""
            echo "Diff:"
            git diff '*.md'
            echo ""
            echo "Please regenerate the Markdown files by running:"
            echo "  go run scripts/yaml-to-markdown.go"
            echo ""
            echo "Then commit the updated Markdown files."
            exit 1
          fi

      - name: Check for untracked Markdown files
        run: |
          # Check for any new .md files that should be committed
          untracked=$(git ls-files --others --exclude-standard '*.md' 2>/dev/null || true)

          if [ -n "$untracked" ]; then
            echo "❌ New Markdown files were generated but not committed:"
            echo "$untracked"
            echo ""
            echo "Please run 'go run scripts/yaml-to-markdown.go' and commit the new files."
            exit 1
          fi
